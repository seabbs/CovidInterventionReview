---
title: "Adoption and impact of non-pharmaceutical interventions for COVID-19"
author: Sam Abbott
date: "2020-02-02"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      cache = FALSE, 
                      fig.path = "figures/")
```

## Package

```{r load-packages, include = FALSE}
## Get required packages - managed using pacman
if (!require(pacman)) install.packages("pacman"); library(pacman)
p_load("data.table")
p_load("dplyr")
p_load("tidyr")
p_load("knitr")
p_load("purrr")
p_load("tibble")
p_load("ggplot2")
p_load("cowplot")
p_load("lubridate")
p_load("readr")

## Load functions
source("functions/get_who_cases.R")
```

## Extract variables of potential interest from linelist

```{r extract-variables}
extracted_linelist <- readr::read_csv("raw-data/linelist.csv") %>%
  dplyr::as_tibble() %>%
  dplyr::select(country, city, province, date_confirmation, travel_history_location) %>%
  dplyr::mutate(import_status = dplyr::if_else(is.na(travel_history_location) |
                                                 travel_history_location == "", "local", "imported"))

extracted_linelist 
```


## Estimate fraction that are imported 

* Based on linelist data alone. Only countries with at least 20 total cases present are shown.

```{r prop-local}
## Based on linelist data
prop_cases_imported <- extracted_linelist %>%
  dplyr::count(country, import_status) %>%
  tidyr::spread(key = "import_status", value = "n") %>%
  dplyr::mutate_at(.vars = c("local", "imported"), ~ replace(., is.na(.), 0)) %>%
  dplyr::mutate(linelist_total = imported + local,
                frac_imported = round(imported / linelist_total, 2)) %>%
  dplyr::filter(linelist_total >= 15, !country %in% c("", "China")) %>%
  dplyr::arrange(desc(frac_imported))
```

* Based on linelist data and WH0 sit reps

```{r}
countries <- prop_cases_imported$country
names(countries) <- prop_cases_imported$country

countries["South Korea"] <- "RepublicofKorea"
countries["United Arab Emirates"] <- "UnitedArabEmirates"
countries["United States"] <- "UnitedStatesofAmerica"
countries["Vietnam"] <- "VietNam"
countries["United Kingdom"] <- "UnitedKingdom"
countries <- countries[!is.na(countries)]

country_cases <- countries %>% 
  purrr::map_dfr(~ get_who_cases(., daily = TRUE), .id = "country")

total_cases <- country_cases %>% 
  dplyr::count(country, wt = cases) %>% 
  dplyr::rename(who_total = n)

prop_cases_imported_who <- prop_cases_imported %>% 
  dplyr::full_join(total_cases, by = "country") %>% 
  dplyr::mutate(who_frac_imported = round(imported / who_total, 2)) %>% 
  dplyr::arrange(desc(who_frac_imported))
```


* Summarise and report

```{r}
tab_cases_imported <- prop_cases_imported_who %>% 
  dplyr::select(Country = country, Cases = who_total, `Fraction imported (linelist only)` = frac_imported,
                `Fraction imported (WHO sit reps)` = who_frac_imported)

saveRDS(tab_cases_imported, "output-data/cases_imported.rds")

knitr::kable(tab_cases_imported)
```


## Plot cases over time


* Wrangle for countries of interest (with at least 40 cases)
```{r}
cum_cases_in_countries <- readr::read_csv("raw-data/countries_of_interest_counts.csv")
```


* Get date of first report

```{r}
cum_cases_in_countries %>% 
  dplyr::group_by(country) %>% 
  dplyr::filter(cases > 0) %>% 
  dplyr::filter(cases == min(cases), date == min(date)) %>% 
  dplyr::ungroup() %>% 
  dplyr::arrange(date) %>% 
  dplyr::select(Country = country, `Date of first case report` = date) %>% 
  knitr::kable()
```

* Get case counts

```{r}
cases_in_countries <- cum_cases_in_countries %>% 
  dplyr::group_by(country) %>% 
  ## Cumulative?
  dplyr::mutate(cases = cases - dplyr::lag(cases)) %>% 
  dplyr::ungroup()

cases_in_countries <- cases_in_countries %>% 
  dplyr::filter(!country %in% "Taiwan") %>% 
  dplyr::mutate(
    cases = ifelse(country %in% "Japan", 
                   ifelse(date == "2020-02-05", 3, 
                          ifelse(date == "2020-02-06", 2, cases)), cases)
  )
```

* Plot curves in countries of interest

```{r, fig.height = 8, fig.width = 12, dpi = 320}
cases_in_countries %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, y = cases)) +
  ggplot2::geom_col() +
  ggplot2::facet_wrap(~ country, scales = "free", ncol = 3) +
  cowplot::theme_cowplot() +
  labs(x = "Date", y = "Cases")
```


## Get interventions


* Plot overall interventions

```{r}
interventions <- readr::read_csv("raw-data/intervention_dates.csv") %>% 
  dplyr::select(date = date_intervention, intervention, country, social_distancing) %>% 
  dplyr::mutate(date = date %>% 
                  stringr::str_replace_all("/", "-")) %>% 
  dplyr::mutate(date = as.Date(date)) %>% 
  dplyr::mutate(country = country %>% 
                  stringr::str_replace_all("south korea", "Republic of Korea") %>% 
                  stringr::str_replace_all("Usa", "United States") %>%
                  stringr::str_to_title() %>% 
                  stringr::str_replace_all("Usa", "United States") %>% 
                  stringr::str_replace_all("Republic Of Korea", "Republic of Korea")) %>% 
  dplyr::mutate(intervention = intervention %>% 
                  stringr::str_replace_all("_", " ") %>% 
                  stringr::str_to_sentence() %>%
                  stringr::str_replace("School restictions", "School restrictions") %>% 
                  stringr::str_replace("Communciation distancing", "Communication distancing"))


summarise_ints <- function(df) {
  df %>% 
  dplyr::select(-date) %>% 
  dplyr::group_by(country, intervention) %>% 
  dplyr::slice(1) %>% 
  dplyr::ungroup() %>% 
  dplyr::count(intervention) %>% 
  tidyr::drop_na(intervention) %>% 
  dplyr::arrange(desc(n)) %>% 
  dplyr::select(Intervention = intervention, 
                `Countries that have implemented` = n)
}


summarise_interventions <- interventions %>% 
  summarise_ints()



saveRDS(summarise_interventions, "output-data/intervention_freq.rds")

knitr::kable(summarise_interventions)
```

* Social interventions only

```{r}
social_interventions <- interventions %>% 
  dplyr::filter(social_distancing %in% "yes") %>% 
  summarise_ints()

saveRDS(social_interventions, "output-data/social_interventions.rds")

knitr::kable(social_interventions)
```

* Non-social interventions

```{r}
non_social_interventions <- interventions %>% 
  dplyr::filter(social_distancing %in% "no") %>% 
  summarise_ints()

saveRDS(non_social_interventions, "output-data/non_social_interventions.rds")

knitr::kable(non_social_interventions)
```

* Plot social interventions

```{r, fig.height = 8, fig.width = 12, dpi = 320}
plot_interventions <- function(intervention_data , n = NULL) {
  plot_df <- cases_in_countries %>% 
  dplyr::left_join(interventions %>% 
                     dplyr::filter(intervention %in% intervention_data[1:n]),
                   by = c("date", "country")) %>% 
  dplyr::group_by(country, date) %>% 
  dplyr::mutate(cases = cases / dplyr::n())
  
  plot_df %>% 
  ggplot2::ggplot(ggplot2::aes(x = date, y = cases, col= intervention)) +
  ggplot2::geom_vline(data = tidyr::drop_na(plot_df, intervention),
                      aes(xintercept = date, col = intervention), size = 1.2) +
  ggplot2::geom_col(col = NA, alpha = 0.6) +
  ggplot2::scale_fill_discrete(na.value = "grey") +
  ggplot2::facet_wrap(~ country, scales = "free", ncol = 3) +
  cowplot::theme_cowplot() +
  labs(x = "Date", y = "Cases") +
  theme(legend.position = "bottom") +
  labs(col = "Intervention", fill = NULL)
}


plot_interventions(social_interventions$Intervention, 12)
```




* Plot non-social interventions

```{r, fig.height = 8, fig.width = 12, dpi = 320}
plot_interventions(non_social_interventions$Intervention, 17)
```


